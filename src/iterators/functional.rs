/// å‡½æ•°å¼è¿­ä»£å™¨
/// * ğŸ¯æœ€åˆç”¨äºã€ŒåŸºäº**é—­åŒ…/å‡½æ•°æŒ‡é’ˆ**çµæ´»å®šä¹‰è¿­ä»£å™¨ã€
/// * ğŸš©ç›´æ¥å®šä¹‰ä¸€ä¸ª[`FnIterator::next`]ï¼Œå¹¶ç›´æ¥åœ¨[`Iterator::next`]ä¸­æ‰§è¡Œ
///   * ğŸ“Œè°ƒç”¨æ—¶çš„ã€Œå¯å˜å…ƒç´ ã€åŸºæœ¬ä¾èµ–é—­åŒ…æ•è·çš„å¤–éƒ¨å˜é‡
/// * âŒæ— æ³•ç”¨äºä»ã€Œç¼“å†²åŒºè¿­ä»£å™¨ã€ç”Ÿæˆã€Œå¤´è¿­ä»£å™¨ã€ï¼šæ— æ³•è¿”å›æŒ‡å‘å¯å˜é—­åŒ…[`FnMut`]çš„å†…éƒ¨å˜é‡çš„å¼•ç”¨
///   * ğŸ“Œå¼ƒç”¨åŸå› ï¼šé—­åŒ…çš„æ‰€æœ‰æƒé—®é¢˜
/// * â—æ ‡å‡†åº“ä¸­å·²ç»æœ‰é›†æˆäº†ï¼šå‚è§[`std::iter::from_fn`]
///   * ğŸ“ä¸€äº›ç»†èŠ‚å®ç°å·®å¼‚
///     * ğŸ“Œæ ‡å‡†åº“ç›´æ¥ä½¿ç”¨å•å…ƒç»„structï¼Œè€Œæœ¬structä½¿ç”¨æ™®é€šç»“æ„ä½“
///     * ğŸ“Œæ ‡å‡†åº“æŠŠã€Œå‡½æ•°ç±»å‹é™åˆ¶ã€ä»ã€Œå®šä¹‰æ—¶ã€ç•™åˆ°äº†ã€Œå®ç°æ—¶ã€
///   * ğŸš©ã€2024-03-10 11:15:11ã€‘ä»£ç è®¡åˆ’å°å­˜ï¼Œä»¥å’Œæ ‡å‡†åº“ä½œå¯¹æ¯”
pub struct FnIterator<F, T>
where
    F: FnMut() -> Option<T>,
{
    f: F,
}

impl<F, T> FnIterator<F, T>
where
    F: FnMut() -> Option<T>,
{
    /// æ„é€ å‡½æ•°ï¼šç›´æ¥åŸºäº å‡½æ•°æŒ‡é’ˆ/é—­åŒ… åˆ›å»ºè¿­ä»£å™¨
    pub fn new(f: F) -> Self {
        Self { f }
    }
}

/// å®ç°æ ‡å‡†è¿­ä»£å™¨æ¥å£
impl<F, T> Iterator for FnIterator<F, T>
where
    F: FnMut() -> Option<T>,
{
    type Item = T;
    fn next(&mut self) -> Option<Self::Item> {
        (self.f)()
    }
}

/// å‡½æ•°å¼è¿­ä»£å™¨
#[test]
fn test_functional_iter() {
    // æ„é€ ä¸€ä¸ªã€Œä¸æ–­è¿­ä»£'a'ã€çš„è¿­ä»£å™¨
    let item = 'a';
    let mut iter = FnIterator::new(|| Some(item));
    const N: usize = 100000;
    for _ in 0..N {
        // è‚¯å®šè¿­ä»£å‡ºå…ƒç´ ï¼Œå¹¶ä¸”æ’ç­‰äº'a'
        assert_eq!(iter.next().unwrap(), item);
    }

    // æ„é€ ä¸€ä¸ª`i32`çš„ç©ºè¿­ä»£å™¨
    let iter = FnIterator::new(|| None::<i32>);
    assert_eq!(iter.count(), 0); // ä¸ä¼šæœ‰è®¡æ•°

    // æ„é€ ä¸€ä¸ªæ–æ³¢é‚£å¥‘è¿­ä»£å™¨
    let mut a_n1: usize = 0;
    let mut a_n2: usize = 0;
    let mut a_n3: usize = 1;
    let mut iter = FnIterator::new(|| {
        // è®¡ç®—æ–°æ•°æ®
        a_n1 = a_n2;
        a_n2 = a_n3;
        a_n3 = a_n1 + a_n2;
        // è¿”å›æ•°æ®
        Some(a_n2)
    });
    assert_eq!(iter.nth(10 - 1).unwrap(), 55); // `10-1`æ‰æ˜¯ã€Œç¬¬10ä¸ªã€
}
