//! ä¸ã€Œåç¼€åŒ¹é…ã€æœ‰å…³çš„å·¥å…·ç»“æ„ä¸ç®—æ³•
//! * ğŸ¯æœ€åˆç”¨äºå­—ç¬¦ä¸²parser
//! * ğŸ¯å­˜å‚¨ä¸“ç”¨çš„ã€Œåç¼€åŒ¹é…ã€å®ç°
//!   * ğŸ“Œåœ¨ã€Œæ ‡ç‚¹ã€ã€ŒçœŸå€¼ã€ç”¨äºã€Œåç¼€åŒ¹é…ã€
//!   * ğŸ“Œåœ¨ã€Œæ—¶é—´æˆ³ã€ç”¨äºã€Œç©ºå‰ç¼€åŒ¹é…ã€
//! * ğŸ“œæ­¤æ–‡ä»¶æ˜¯ç›´æ¥ä»ã€Œå‰ç¼€åŒ¹é…ã€æ‹¿è¿‡æ¥çš„
//!   * ğŸ’­è™½è¯´è¦åŒæ—¶ç»´æŠ¤ï¼Œä½†æƒ…å†µè¾ƒå°‘

use super::traits::*;

/// ã€Œåç¼€æ¡ç›®ã€
/// * ğŸ¯ç»Ÿä¸€è¡¨è¾¾`(å…³è”å†…å®¹, åç¼€)`çš„äºŒå…ƒç»„
type SuffixTerm<T, XFix = Suffix> = (T, XFix);

/// åç¼€é…å¯¹å­—å…¸
/// * ğŸš©å…·ä½“é€»è¾‘ï¼š
///   * ã€å€’åºã€‘ç»´æŠ¤ä¸€ä¸ªæœ‰ä¸€å®šé¡ºåºã€ä¸é‡å¤çš„[`String`]æ•°ç»„
///   * ä½¿ç”¨ã€ŒäºŒå…ƒç»„ã€ç›´æ¥åœ¨æ•°ç»„å†…å»ºç«‹ã€Œå­—ç¬¦ä¸²â‡’å…¶å®ƒå…ƒç´ ã€çš„å…³è”
#[derive(Debug, Clone)]
pub struct SuffixMatchDictPair<T> {
    /// * ğŸ¯æ­¤å¤„è®¾è®¡æˆ`(å…³è”å†…å®¹, åç¼€)`å…ƒç»„é¡ºåºï¼Œçº¯ç²¹ä¸ºäº†ä»£ç ä¸Š`("<", ">")`å¯¹ç§°
    pub(super) suffixes: Vec<SuffixTerm<T>>,
}

/// å®ç°ã€Œé»˜è®¤æ„é€ å‡½æ•°ã€
/// * ğŸš©é€šè¿‡ã€Œåˆå§‹åŒ–ç©ºæ•°ç»„ã€å®Œæˆ
impl<T> Default for SuffixMatchDictPair<T> {
    fn default() -> Self {
        Self {
            suffixes: Vec::new(),
        }
    }
}

/// é€šè¿‡å®å¿«æ·æ„é€ ã€Œåç¼€é…å¯¹å­—å…¸ã€
/// * ğŸ“Œæ ¼å¼ï¼šã€Œå‰ => åã€
#[macro_export]
macro_rules! suffix_match_dict_pair {
    // è½¬æ¢å…¶ä¸­çš„å€¼ | é™æ€å­—ä¸²â‡’åŠ¨æ€å­—ä¸² è‡ªåŠ¨`into`
    (@value $v:literal) => {
        $v.into()
    };
    // è½¬æ¢å…¶ä¸­çš„å€¼ | è¡¨è¾¾å¼â‡’ç›´æ¥åŠ å…¥
    (@value $v:expr) => {
        $v
    };
    // ç»Ÿä¸€çš„è¡¨ | è‡ªé¢é‡ä¹Ÿæ˜¯ä¸€ç§è¡¨è¾¾å¼
    [$($suffix:expr => $item:expr $(,)?)*] => {{
        let mut d = $crate::SuffixMatchDictPair::default();
        $(
            d.insert((
                suffix_match_dict_pair!(@value $suffix),
                suffix_match_dict_pair!(@value $item),
            ));
        )*
        d
    }};
}

/// å®ç°ä¸“ç”¨æ–¹æ³•
impl<T> SuffixMatchDictPair<T> {
    /// æ„é€ å‡½æ•°
    /// * âš ï¸å®é™…ä¸Šä¸æ¨èä»æ‰€è°“ã€Œè¿­ä»£å™¨ã€ç›´æ¥åˆ›å»ºæ•°ç»„ï¼š**éš¾ä»¥é¢„å…ˆæ’åº**
    /// * ğŸš©ç°åœ¨é‡‡ç”¨ã€Œå…ˆæ–°å»ºç©ºå€¼ï¼Œç„¶åé€ä¸ªæ·»åŠ ã€æ¥å®ç°
    ///   * ğŸ“Œå¤æ‚åº¦ï¼šâˆ‘ 1 log 1 ~ n log n
    /// * ğŸ“Œæ ¼å¼ï¼š`æ¡ç›®=(å…¶å®ƒå…ƒç´ , åç¼€)`
    pub fn new(suffixes: impl IntoIterator<Item = SuffixTerm<T, impl Into<Suffix>>>) -> Self {
        // ! âŒã€2024-03-17 16:42:39ã€‘ä¸å†å°è¯•æå–æ„é€ å‡½æ•°
        // ä½¿ç”¨`default`åˆ›å»ºä¸€ä¸ªç©ºå€¼
        let mut dict = Self::default();
        // é€ä¸ªæ·»åŠ 
        for term_to_into in suffixes.into_iter() {
            // é’ˆå¯¹`Into`åšä¸€ä¸ªã€Œè½¬æ¢å†æ’å…¥ã€
            // ! ä»ç„¶æ— æ³•ä½¿ç”¨`get_associated_from_term`ï¼šè¿™æ—¶å€™çš„`term_to_into`è¿˜ä¸æ˜¯`term`
            dict.insert(Self::new_suffix_term(term_to_into.1.into(), term_to_into.0));
        }
        // è¿”å›
        dict
    }

    /// åç¼€æ¡ç›®â†’åç¼€ï¼ˆå¼•ç”¨ï¼‰
    /// * ğŸ“Œæ˜¯`&String`è€Œé`&str`ï¼ŒçœŸæ­£å¼•ç”¨åˆ°åç¼€å®ä¾‹æœ¬èº«
    /// * âš ï¸ã€2024-03-17 16:04:52ã€‘ç›®å‰æš‚æ— æ³•æå–è‡³ç‰¹å¾
    ///   * ğŸ“ŒåŸå› ï¼šå¯¹ã€Œè¯ç¼€åŒ¹é…å­—å…¸ã€æ— æ³•å®¹å¿ã€Œ(è‡ªèº«, è‡ªèº«)ã€å‚æ•°
    #[inline(always)]
    pub fn suffix_ref_of(term: &SuffixTerm<T>) -> &Suffix {
        &term.1
    }

    /// ç”¨äºä»ä¸€ä¸ªã€Œåç¼€æ¡ç›®ã€ä¸­è·å–ã€Œå…³è”å†…å®¹ã€
    /// * âš ï¸ã€2024-03-17 13:05:43ã€‘ç›®å‰æš‚æ— æ³•æå–è‡³ç‰¹å¾
    ///   * ğŸ“ŒåŸå› ï¼šå¯¹ã€Œè¯ç¼€åŒ¹é…å­—å…¸ã€æ— æ³•å®¹å¿ã€Œ(è‡ªèº«, è‡ªèº«)ã€å‚æ•°
    #[inline(always)]
    pub fn get_associated_from_term(term: &SuffixTerm<T>) -> &T {
        &term.0
    }

    /// ä»ã€Œåç¼€ã€ä¸ã€Œå…³è”å†…å®¹ã€ç»„è£…ã€Œåç¼€æ¡ç›®ã€
    /// * âš ï¸ã€2024-03-17 13:05:43ã€‘ç›®å‰æš‚æ— æ³•æå–è‡³ç‰¹å¾
    ///   * ğŸ“ŒåŸå› ï¼šå¯¹ã€Œè¯ç¼€åŒ¹é…å­—å…¸ã€æ— æ³•å®¹å¿ã€Œ(è‡ªèº«, è‡ªèº«)ã€å‚æ•°
    #[inline(always)]
    pub fn new_suffix_term(suffix: Suffix, associated: T) -> SuffixTerm<T> {
        (associated, suffix)
    }

    /// åˆ¤æ–­ã€Œæ˜¯å¦å·²æœ‰ä¸€ä¸ªåç¼€ã€
    /// * ğŸ“Œç›´æ¥ä½¿ç”¨è‡ªèº«çš„ã€Œæœç´¢ã€åŠŸèƒ½
    /// * âš ï¸å› æ¶‰åŠã€æ¶‰åŠå†…éƒ¨å­—æ®µã€‘çš„[`Self::search`]æ–¹æ³•ï¼Œæ— æ³•æå–è‡³ç‰¹å¾
    #[inline(always)]
    pub fn has(&self, suffix: &Suffix) -> bool {
        // * ğŸš©æŸ¥æ‰¾ã€Œokã€è¯æ˜ã€Œèƒ½æ‰¾åˆ°ã€
        self.search(suffix).is_ok()
    }

    /// æ’å…¥ä¸€ä¸ªæ¡ç›®
    /// * ğŸš©è°ƒç”¨ç»åˆ†æ´¾çš„ã€ŒæŸ¥æ‰¾ã€æ–¹æ³•
    /// * ğŸš©è¿”å›ã€Œæ’å…¥åå…ƒç´ ä½ç½®çš„ç´¢å¼•ã€
    ///   * ğŸ¯ç›¸æ¯”ã€Œæ˜¯å¦æ’å…¥ã€æä¾›äº†ã€Œæ’å…¥åçš„å…ƒç´ ã€çš„ä¿¡æ¯
    ///   * ğŸ“**è‹¥è¿”å›ã€Œæ’å…¥åå…ƒç´ çš„å¼•ç”¨ã€ï¼Œåˆ™ä¼šå¯¼è‡´å­—æ®µè¿å¸¦è‡ªèº«è¢«æŒç»­å€Ÿç”¨**
    ///     * â—å› æ­¤å¯¼è‡´ã€Œå€Ÿäº†ä¸è¿˜ã€çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜
    ///     * âœ¨æ­¤æ—¶è¿˜ä¸å¦‚è¿”å›ç´¢å¼•ï¼Œè®©è°ƒç”¨è€…æ ¹æ®ç´¢å¼•è°ƒç”¨
    pub fn insert(&mut self, term: SuffixTerm<T>) -> Option<usize> {
        // åªæœ‰åœ¨ã€ŒæŸ¥æ‰¾å¤±è´¥ã€æ—¶è¿›è¡Œæ’å…¥
        if let Err(index) = self.search(Self::get_suffix_from_term(&term)) {
            // ç›´æ¥è°ƒç”¨æ•°ç»„çš„ã€Œæ’å…¥ã€æ–¹æ³•
            self.suffixes.insert(index, term);
            return Some(index);
        }
        // æ’å…¥å¤±è´¥â‡’å¤±è´¥
        None
    }

    /// ï¼ˆå‰åç¼€æ— å…³ï¼‰ä»¥ç‰¹æ®Šé¡ºåºè¿­ä»£ã€Œè¯ç¼€ã€
    /// * ğŸ¯ç»Ÿä¸€ã€Œå‰åç¼€åŒ¹é…ã€çš„è¿­ä»£é€»è¾‘
    /// * ğŸš©æ€»æ˜¯æŒ‰ç…§ã€Œå­—å…¸é¡ºåºã€å€’åºéå†ï¼š**é•¿åº¦ä»é•¿åˆ°çŸ­**
    #[inline(always)]
    pub fn iter_terms<'a>(&'a self) -> impl Iterator<Item = &SuffixTerm<T>> + 'a
    where
        String: 'a,
    {
        // ! ã€2024-03-17 12:34:00ã€‘æ­¤å¤„å› ä¸ºã€ŒåŸå…ˆå°±ä»¥å€’åºå­˜å‚¨ã€æ‰€ä»¥ç›´æ¥é¡ºåºéå†
        self.suffixes.iter()
    }

    /// æœç´¢ | ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾
    /// * ğŸ¯æ„é€ å¯æ–¹ä¾¿æ›¿æ¢çš„ã€ŒæŸ¥æ‰¾ã€é€»è¾‘
    /// * ğŸš©æ‰¾åˆ°â‡’ä½ç½®ï¼Œæ²¡æ‰¾åˆ°â‡’åº”è¯¥æ’å…¥çš„ä½ç½®
    ///   * ğŸ“Œè¿™ä¸ªã€Œåº”è¯¥æ’å…¥çš„ä½ç½®ã€éœ€è¦**è®©æ’å…¥åã€Œä»å¤§åˆ°å°æ’åˆ—ã€**
    ///   * ğŸ“Œäº¦å³ã€æ¸è¿›å¼æ„å»ºã€‘ã€Œåç¼€ä»é•¿åˆ°çŸ­çš„æ•°ç»„ã€
    /// * ğŸ“Œã€2024-03-17 12:13:14ã€‘å®é™…ä¸Šå¯¹ã€Œå¾…æ’å…¥çš„æ¡ç›®ã€åªéœ€è¦å…¶åç¼€ä¿¡æ¯
    ///   * æ•…ç›´æ¥æ ¹æ®åç¼€å¯»æ‰¾
    /// * âš ï¸å› æ¶‰åŠã€Œå†…éƒ¨æ•°ç»„ã€æ‰€ä»¥ã€æ— æ³•æå–è‡³é€šç”¨ç‰¹å¾ã€‘
    #[inline(always)]
    pub fn search(&self, suffix: &SuffixStr) -> Result<usize, usize> {
        super::search_by(&self.suffixes, &suffix, |suffix, existed| {
            // ! âš ï¸ä¸è¦åœ¨æ­¤æ·»åŠ `.reverse()`ï¼šé™å®šåœ¨`cmpä¹‹å†…è§£å†³
            // * ğŸ“Œä¿è¯æ’å…¥åã€Œæ¯”è‡ªå·±å¤§çš„ > è‡ªå·± > å·²å­˜åœ¨ã€
            Self::cmp_suffix(existed, suffix) // â†ç”±äºŒåˆ†æŸ¥æ‰¾çš„ã€Œä»å°åˆ°å¤§ã€é€†è½¬ä¸ºã€Œä»å¤§åˆ°å°ã€
        })
    }
}

/// å®ç°ã€Œåç¼€åŒ¹é…ã€é€»è¾‘
impl<T> SuffixMatch<SuffixTerm<T>> for SuffixMatchDictPair<T> {
    // ä¸‹é¢çš„æ–¹æ³•ç›´æ¥è¿›è¡Œã€Œç‰¹åŒ–é‡å®šå‘ã€å¤„ç† //
    fn get_suffix_from_term(term: &SuffixTerm<T>) -> &SuffixStr {
        // è¿”å›çš„ã€Œåç¼€å¼•ç”¨ã€ã€è‡ªåŠ¨è½¬æ¢ã€‘ä¸ºé™æ€å¼•ç”¨ | &String -> &str
        Self::suffix_ref_of(term)
    }
    fn suffix_terms<'a>(&'a self) -> impl Iterator<Item = &'a SuffixTerm<T>> + 'a
    where
        SuffixTerm<T>: 'a,
    {
        self.iter_terms()
    }
}

/// å•å…ƒæµ‹è¯•/åç¼€åŒ¹é…
#[cfg(test)]
mod tests {
    use super::*;
    use crate::{show, test_match_suffix};

    /// æµ‹è¯•/è¾¹ç¼˜
    #[test]
    fn test_edge() {
        //æ„é€ æµ‹è¯•ç”¨ä¾‹
        let d: SuffixMatchDictPair<String> = suffix_match_dict_pair!(
            "0" => ""  // ç©ºå€¼fallback
            "1" => "a"
            "2" => "aa"
            "3" => "aaa"
        );
        show!(&d);
        // å¼€å§‹åŒ¹é…
        test_match_suffix! {
            d;
            // å®Œå…¨åŒ¹é…
            "a" => Some("1")
            "aa" => Some("2")
            "aaa" => Some("3")
            // èŒƒå›´å†…æƒ…å†µ
            "_a" => Some("1")
            "_aa" => Some("2")
            "_aaa" => Some("3")
            // ç©ºå€¼fallback
            "" => Some("0")
            "b" => Some("0")
        }
    }

    /// æµ‹è¯•/å®æˆ˜
    #[test]
    fn test_suffix_match_pairs() {
        // æµ‹è¯•ã€Œæ‹¬å¼§åŒ¹é…ã€
        let d: SuffixMatchDictPair<String> = suffix_match_dict_pair!(
            "(" => ")"
            "[" => "]"
            "{" => "}"
            "<" => ">"
        );
        show!(&d);
        // æµ‹è¯•åç¼€åŒ¹é…
        test_match_suffix! {
            d;
            // èŒƒå›´å†…æƒ…å†µ | â—åç¼€â‡’å‰ç¼€
            r"(A, B, C)" => Some("(")
            r"[A, B, C]" => Some("[")
            r"{A, B, C}" => Some("{")
            r"<A, B, C>" => Some("<")
            // æ— æ•ˆæƒ…å†µ
            "word" => None
        }

        // æµ‹è¯•ã€ŒçœŸå€¼ã€ã€Œæ—¶é—´æˆ³ã€åŒ¹é…
        let d: SuffixMatchDictPair<String> = suffix_match_dict_pair!(
            // çœŸå€¼ //
            "%" => "%"
            r"\langle{}" => r"\rangle{}"
            "çœŸ" => "å€¼"
            // æ—¶é—´æˆ³ //
            // ASCII
            "" => r":\:" // è¿‡å»
            "" => r":|:" // ç°åœ¨
            "" => r":/:" // å°†æ¥
            ":!" => r":" // å›ºå®š
            // LaTeX
            "" => r"\backslash\!\!\!\Rightarrow{}" // è¿‡å»
            "" => r"|\!\!\!\Rightarrow{}" // ç°åœ¨
            "" => r"/\!\!\!\Rightarrow{}" // å°†æ¥
            "t=" => "", // å›ºå®š // ! ç©ºå€¼fallback
            // æ¼¢æ–‡
            "" => "è¿‡å»" // è¿‡å»
            "" => "ç°åœ¨" // ç°åœ¨
            "" => "å°†æ¥" // å°†æ¥
            // "å‘ç”Ÿåœ¨" => "", // ! â†æ­¤å¤„é‡å¤äº†
        );
        show!(&d);
        // æµ‹è¯•åç¼€åŒ¹é…
        test_match_suffix! {
            d;
            // èŒƒå›´å†…æƒ…å†µ | â—åç¼€â‡’å‰ç¼€ //
            // ASCII
            r"<A --> B>. :\:" => Some("") // ! ç©ºå‰ç¼€ç­–ç•¥
            r"<A --> B>. :|:" => Some("") // ! ç©ºå‰ç¼€ç­–ç•¥
            r"<A --> B>. :/:" => Some("") // ! ç©ºå‰ç¼€ç­–ç•¥
            r"<A --> B>. :!-137:" => Some(r":!")
            // LaTeX
            r"\left<A \rightarrow{} B\right>. \backslash\!\!\!\Rightarrow{}" => Some("")
            r"\left<A \rightarrow{} B\right>. |\!\!\!\Rightarrow{}" => Some("")
            r"\left<A \rightarrow{} B\right>. /\!\!\!\Rightarrow{}" => Some("")
            r"\left<A \rightarrow{} B\right>." => Some("t=") // ! fallback
            // æ¼¢æ–‡
            "ã€ŒAæ˜¯Bã€ã€‚è¿‡å»" => Some("")
            "ã€ŒAæ˜¯Bã€ã€‚ç°åœ¨" => Some("")
            "ã€ŒAæ˜¯Bã€ã€‚å°†æ¥" => Some("")
        }
    }
}
