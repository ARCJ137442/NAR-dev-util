//! ä¸ã€Œå‰ç¼€åŒ¹é…ã€æœ‰å…³çš„å·¥å…·ç»“æ„ä¸ç®—æ³•
//! * ğŸ¯æœ€åˆç”¨äºå­—ç¬¦ä¸²parser
//! * ğŸ¯å­˜å‚¨ä¸“ç”¨çš„ã€Œå‰ç¼€åŒ¹é…ã€å®ç°
//! * ğŸ“Œã€2024-03-17 14:18:01ã€‘ç°åœ¨ä»ã€Œåç¼€åŒ¹é…ã€å­æ¨¡å—è¿ç§»è€Œæ¥

use super::traits::*;

/// ã€Œå‰ç¼€æ¡ç›®ã€
/// * ğŸ¯ç»Ÿä¸€è¡¨è¾¾`(å…³è”å†…å®¹, å‰ç¼€)`çš„äºŒå…ƒç»„
type PrefixTerm<T, XFix = Prefix> = (XFix, T);

/// å‰ç¼€é…å¯¹å­—å…¸
/// * ğŸš©å…·ä½“é€»è¾‘ï¼š
///   * ã€å€’åºã€‘ç»´æŠ¤ä¸€ä¸ªæœ‰ä¸€å®šé¡ºåºã€ä¸é‡å¤çš„[`String`]æ•°ç»„
///   * ä½¿ç”¨ã€ŒäºŒå…ƒç»„ã€ç›´æ¥åœ¨æ•°ç»„å†…å»ºç«‹ã€Œå­—ç¬¦ä¸²â‡’å…¶å®ƒå…ƒç´ ã€çš„å…³è”
#[derive(Debug, Clone)]
pub struct PrefixMatchDictPair<T> {
    /// * ğŸ¯æ­¤å¤„è®¾è®¡æˆ`(å…³è”å†…å®¹, å‰ç¼€)`å…ƒç»„é¡ºåºï¼Œçº¯ç²¹ä¸ºäº†ä»£ç ä¸Š`("<", ">")`å¯¹ç§°
    pub(super) prefixes: Vec<PrefixTerm<T>>,
}

/// å®ç°ã€Œé»˜è®¤æ„é€ å‡½æ•°ã€
/// * ğŸš©é€šè¿‡ã€Œåˆå§‹åŒ–ç©ºæ•°ç»„ã€å®Œæˆ
impl<T> Default for PrefixMatchDictPair<T> {
    fn default() -> Self {
        Self {
            prefixes: Vec::new(),
        }
    }
}

/// é€šè¿‡å®å¿«æ·æ„é€ ã€Œå‰ç¼€é…å¯¹å­—å…¸ã€
/// * ğŸ“Œæ ¼å¼ï¼šã€Œå‰ => åã€
#[macro_export]
macro_rules! prefix_match_dict_pair {
    // è½¬æ¢å…¶ä¸­çš„å€¼ | é™æ€å­—ä¸²â‡’åŠ¨æ€å­—ä¸² è‡ªåŠ¨`into`
    (@value $v:literal) => {
        $v.into()
    };
    // è½¬æ¢å…¶ä¸­çš„å€¼ | è¡¨è¾¾å¼â‡’ç›´æ¥åŠ å…¥
    (@value $v:expr) => {
        $v
    };
    // ç»Ÿä¸€çš„è¡¨ | è‡ªé¢é‡ä¹Ÿæ˜¯ä¸€ç§è¡¨è¾¾å¼
    [$($prefix:expr => $item:expr $(,)?)*] => {{
        let mut d = $crate::PrefixMatchDictPair::default();
        $(
            d.insert((
                prefix_match_dict_pair!(@value $prefix),
                prefix_match_dict_pair!(@value $item),
            ));
        )*
        d
    }};
}

/// å®ç°ä¸“ç”¨æ–¹æ³•
impl<T> PrefixMatchDictPair<T> {
    /// æ„é€ å‡½æ•°
    /// * âš ï¸å®é™…ä¸Šä¸æ¨èä»æ‰€è°“ã€Œè¿­ä»£å™¨ã€ç›´æ¥åˆ›å»ºæ•°ç»„ï¼š**éš¾ä»¥é¢„å…ˆæ’åº**
    /// * ğŸš©ç°åœ¨é‡‡ç”¨ã€Œå…ˆæ–°å»ºç©ºå€¼ï¼Œç„¶åé€ä¸ªæ·»åŠ ã€æ¥å®ç°
    ///   * ğŸ“Œå¤æ‚åº¦ï¼šâˆ‘ 1 log 1 ~ n log n
    /// * ğŸ“Œæ ¼å¼ï¼š`æ¡ç›®=(å…¶å®ƒå…ƒç´ , å‰ç¼€)`
    pub fn new(prefixes: impl IntoIterator<Item = PrefixTerm<T, impl Into<Prefix>>>) -> Self {
        // ! âŒã€2024-03-17 16:42:39ã€‘ä¸å†å°è¯•æå–æ„é€ å‡½æ•°
        // ä½¿ç”¨`default`åˆ›å»ºä¸€ä¸ªç©ºå€¼
        let mut dict = Self::default();
        // é€ä¸ªæ·»åŠ 
        for term_to_into in prefixes.into_iter() {
            // é’ˆå¯¹`Into`åšä¸€ä¸ªã€Œè½¬æ¢å†æ’å…¥ã€
            // ! ä»ç„¶æ— æ³•ä½¿ç”¨`get_associated_from_term`ï¼šè¿™æ—¶å€™çš„`term_to_into`è¿˜ä¸æ˜¯`term`
            dict.insert(Self::new_prefix_term(term_to_into.0.into(), term_to_into.1));
        }
        // è¿”å›
        dict
    }

    /// å‰ç¼€æ¡ç›®â†’å‰ç¼€ï¼ˆå¼•ç”¨ï¼‰
    /// * ğŸ“Œæ˜¯`&String`è€Œé`&str`ï¼ŒçœŸæ­£å¼•ç”¨åˆ°å‰ç¼€å®ä¾‹æœ¬èº«
    /// * âš ï¸ã€2024-03-17 16:04:52ã€‘ç›®å‰æš‚æ— æ³•æå–è‡³ç‰¹å¾
    ///   * ğŸ“ŒåŸå› ï¼šå¯¹ã€Œè¯ç¼€åŒ¹é…å­—å…¸ã€æ— æ³•å®¹å¿ã€Œ(è‡ªèº«, è‡ªèº«)ã€å‚æ•°
    #[inline(always)]
    pub fn prefix_ref_of(term: &PrefixTerm<T>) -> &Prefix {
        &term.0
    }

    /// ç”¨äºä»ä¸€ä¸ªã€Œå‰ç¼€æ¡ç›®ã€ä¸­è·å–ã€Œå…³è”å†…å®¹ã€
    /// * âš ï¸ã€2024-03-17 13:05:43ã€‘ç›®å‰æš‚æ— æ³•æå–è‡³ç‰¹å¾
    ///   * ğŸ“ŒåŸå› ï¼šå¯¹ã€Œè¯ç¼€åŒ¹é…å­—å…¸ã€æ— æ³•å®¹å¿ã€Œ(è‡ªèº«, è‡ªèº«)ã€å‚æ•°
    #[inline(always)]
    pub fn get_associated_from_term(term: &PrefixTerm<T>) -> &T {
        &term.1
    }

    /// ä»ã€Œå‰ç¼€ã€ä¸ã€Œå…³è”å†…å®¹ã€ç»„è£…ã€Œå‰ç¼€æ¡ç›®ã€
    /// * âš ï¸ã€2024-03-17 13:05:43ã€‘ç›®å‰æš‚æ— æ³•æå–è‡³ç‰¹å¾
    ///   * ğŸ“ŒåŸå› ï¼šå¯¹ã€Œè¯ç¼€åŒ¹é…å­—å…¸ã€æ— æ³•å®¹å¿ã€Œ(è‡ªèº«, è‡ªèº«)ã€å‚æ•°
    #[inline(always)]
    pub fn new_prefix_term(prefix: Prefix, associated: T) -> PrefixTerm<T> {
        (prefix, associated)
    }

    /// åˆ¤æ–­ã€Œæ˜¯å¦å·²æœ‰ä¸€ä¸ªå‰ç¼€ã€
    /// * ğŸ“Œç›´æ¥ä½¿ç”¨è‡ªèº«çš„ã€Œæœç´¢ã€åŠŸèƒ½
    /// * âš ï¸å› æ¶‰åŠã€æ¶‰åŠå†…éƒ¨å­—æ®µã€‘çš„[`Self::search`]æ–¹æ³•ï¼Œæ— æ³•æå–è‡³ç‰¹å¾
    #[inline(always)]
    pub fn has(&self, prefix: &Prefix) -> bool {
        // * ğŸš©æŸ¥æ‰¾ã€Œokã€è¯æ˜ã€Œèƒ½æ‰¾åˆ°ã€
        self.search(prefix).is_ok()
    }

    /// æ’å…¥ä¸€ä¸ªæ¡ç›®
    /// * ğŸš©è°ƒç”¨ç»åˆ†æ´¾çš„ã€ŒæŸ¥æ‰¾ã€æ–¹æ³•
    /// * ğŸš©è¿”å›ã€Œæ’å…¥åå…ƒç´ ä½ç½®çš„ç´¢å¼•ã€
    ///   * ğŸ¯ç›¸æ¯”ã€Œæ˜¯å¦æ’å…¥ã€æä¾›äº†ã€Œæ’å…¥åçš„å…ƒç´ ã€çš„ä¿¡æ¯
    ///   * ğŸ“**è‹¥è¿”å›ã€Œæ’å…¥åå…ƒç´ çš„å¼•ç”¨ã€ï¼Œåˆ™ä¼šå¯¼è‡´å­—æ®µè¿å¸¦è‡ªèº«è¢«æŒç»­å€Ÿç”¨**
    ///     * â—å› æ­¤å¯¼è‡´ã€Œå€Ÿäº†ä¸è¿˜ã€çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜
    ///     * âœ¨æ­¤æ—¶è¿˜ä¸å¦‚è¿”å›ç´¢å¼•ï¼Œè®©è°ƒç”¨è€…æ ¹æ®ç´¢å¼•è°ƒç”¨
    ///     * ğŸ“Œå…³é”®æ³¨æ„ç‚¹ï¼š**è¿”å›å¼•ç”¨è¦æ…é‡**
    ///   * ğŸ“âœ¨ä¸€ä¸ªå¯¹ã€Œç”Ÿå‘½å‘¨æœŸé—®é¢˜ã€éå¸¸å®ç”¨çš„**é”™è¯¯è¿½æº¯æ–¹æ³•**ï¼šå†…è”
    ///     * ğŸ“Œæ ¸å¿ƒåŸç†ã€Œä»£ç å¤šæ€ã€ï¼šå‡½æ•°å†…è”åçš„ä»£ç ï¼Œåªéœ€ç¨åŠ ä¿®æ”¹å…¶ä¸­çš„`return`ï¼Œå°±èƒ½ç›´æ¥æ›¿æ¢è°ƒç”¨å¤„çš„è¡¨è¾¾å¼
    ///       * ğŸ“„ä¾æ®ï¼šå—ä½œç”¨åŸŸã€å—è¡¨è¾¾å¼â€”â€”è¯­å¥å—ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„ä½œç”¨åŸŸï¼Œä¸”å¯ä»¥è¢«æ±‚å€¼
    ///     * ğŸš©å€ŸåŠ©ç¼–è¾‘å™¨çš„ã€Œä»£ç inlineã€åŠŸèƒ½ï¼Œä¸æ–­å±•å¼€æ‰€è°ƒç”¨çš„ä»£ç ï¼Œç›´åˆ°æ— æ³•å±•å¼€
    ///       * ğŸ“Œæœ€åä¸€èˆ¬ä¼šè¿½æº¯åˆ°ã€Œå­—æ®µè®¿é—®ã€ã€Œæ ‡å‡†åº“å‡½æ•°ã€ç­‰åŸºç¡€æ“ä½œ
    ///       * âœ…æ­¤æ—¶ä¾¿å¯ä»å…¨å±€è§’åº¦å®¡è§†ä»£ç 
    pub fn insert(&mut self, term: PrefixTerm<T>) -> Option<usize> {
        // åªæœ‰åœ¨ã€ŒæŸ¥æ‰¾å¤±è´¥ã€æ—¶è¿›è¡Œæ’å…¥
        if let Err(index) = self.search(Self::get_prefix_from_term(&term)) {
            // ç›´æ¥è°ƒç”¨æ•°ç»„çš„ã€Œæ’å…¥ã€æ–¹æ³•
            self.prefixes.insert(index, term);
            // * ğŸ“Œã€2024-03-17 19:08:37ã€‘æ’å…¥åè¿˜æ˜¯é‚£ä¸ªä½ç½®ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ï¼ˆè€Œéå†å€Ÿç”¨ï¼‰
            return Some(index);
        }
        // æ’å…¥å¤±è´¥â‡’å¤±è´¥
        None
    }

    /// ï¼ˆå‰å‰ç¼€æ— å…³ï¼‰ä»¥ç‰¹æ®Šé¡ºåºè¿­ä»£ã€Œè¯ç¼€ã€
    /// * ğŸ¯ç»Ÿä¸€ã€Œå‰å‰ç¼€åŒ¹é…ã€çš„è¿­ä»£é€»è¾‘
    /// * ğŸš©æ€»æ˜¯æŒ‰ç…§ã€Œå­—å…¸é¡ºåºã€å€’åºéå†ï¼š**é•¿åº¦ä»é•¿åˆ°çŸ­**
    #[inline(always)]
    pub fn iter_terms<'a>(&'a self) -> impl Iterator<Item = &PrefixTerm<T>> + 'a
    where
        String: 'a,
    {
        // ! ã€2024-03-17 12:34:00ã€‘æ­¤å¤„å› ä¸ºã€ŒåŸå…ˆå°±ä»¥å€’åºå­˜å‚¨ã€æ‰€ä»¥ç›´æ¥é¡ºåºéå†
        self.prefixes.iter()
    }

    /// æœç´¢
    /// * ğŸ¯æ„é€ å¯æ–¹ä¾¿æ›¿æ¢çš„ã€ŒæŸ¥æ‰¾ã€é€»è¾‘
    /// * ğŸš©æ‰¾åˆ°â‡’ä½ç½®ï¼Œæ²¡æ‰¾åˆ°â‡’åº”è¯¥æ’å…¥çš„ä½ç½®
    ///   * ğŸ“Œè¿™ä¸ªã€Œåº”è¯¥æ’å…¥çš„ä½ç½®ã€éœ€è¦**è®©æ’å…¥åã€Œä»å¤§åˆ°å°æ’åˆ—ã€**
    ///   * ğŸ“Œäº¦å³ã€æ¸è¿›å¼æ„å»ºã€‘ã€Œå‰ç¼€ä»é•¿åˆ°çŸ­çš„æ•°ç»„ã€
    /// * ğŸ“Œã€2024-03-17 12:13:14ã€‘å®é™…ä¸Šå¯¹ã€Œå¾…æ’å…¥çš„æ¡ç›®ã€åªéœ€è¦å…¶å‰ç¼€ä¿¡æ¯
    ///   * æ•…ç›´æ¥æ ¹æ®å‰ç¼€å¯»æ‰¾
    /// * âš ï¸å› æ¶‰åŠã€Œå†…éƒ¨æ•°ç»„ã€æ‰€ä»¥ã€æ— æ³•æå–è‡³é€šç”¨ç‰¹å¾ã€‘
    #[inline(always)]
    pub fn search(&self, prefix: &PrefixStr) -> Result<usize, usize> {
        super::search_by(&self.prefixes, &prefix, |prefix, existed| {
            // ! âš ï¸ä¸è¦åœ¨æ­¤æ·»åŠ `.reverse()`ï¼šé™å®šåœ¨`cmpä¹‹å†…è§£å†³
            // * ğŸ“Œä¿è¯æ’å…¥åã€Œæ¯”è‡ªå·±å¤§çš„ > è‡ªå·± > å·²å­˜åœ¨ã€
            Self::cmp_prefix(existed, prefix)
        })
    }
}

/// å®ç°ã€Œå‰ç¼€åŒ¹é…ã€é€»è¾‘
impl<T> PrefixMatch<PrefixTerm<T>> for PrefixMatchDictPair<T> {
    // ä¸‹é¢çš„æ–¹æ³•ç›´æ¥è¿›è¡Œã€Œç‰¹åŒ–é‡å®šå‘ã€å¤„ç† //
    fn get_prefix_from_term(term: &PrefixTerm<T>) -> &PrefixStr {
        // è¿”å›çš„ã€Œå‰ç¼€å¼•ç”¨ã€ã€è‡ªåŠ¨è½¬æ¢ã€‘ä¸ºé™æ€å¼•ç”¨ | &String -> &str
        Self::prefix_ref_of(term)
    }
    fn prefix_terms<'a>(&'a self) -> impl Iterator<Item = &'a PrefixTerm<T>> + 'a
    where
        PrefixTerm<T>: 'a,
    {
        self.iter_terms()
    }
}

/// å•å…ƒæµ‹è¯•/å‰ç¼€åŒ¹é…
#[cfg(test)]
mod tests {
    use super::*;
    use crate::{show, test_match_prefix};

    /// æµ‹è¯•/è¾¹ç¼˜
    #[test]
    fn test_edge() {
        // æ„é€ æµ‹è¯•ç”¨ä¾‹
        let d: PrefixMatchDictPair<String> = prefix_match_dict_pair!(
            "" => "0" // ç©ºå€¼fallback
            "a" => "1"
            "aa" => "2"
            "aaa" => "3"
        );
        show!(&d);
        // å¼€å§‹åŒ¹é…
        test_match_prefix! {
            d;
            // å®Œå…¨åŒ¹é…
            "a" => Some("1")
            "aa" => Some("2")
            "aaa" => Some("3")
            // èŒƒå›´å†…æƒ…å†µ
            "a_" => Some("1")
            "aa_" => Some("2")
            "aaa_" => Some("3")
            // ç©ºå€¼fallback
            "" => Some("0")
            "b" => Some("0")
        }
    }

    /// æµ‹è¯•/å®æˆ˜
    #[test]
    fn test_prefix_match_pairs() {
        // æµ‹è¯•ã€Œæ‹¬å¼§åŒ¹é…ã€
        let d: PrefixMatchDictPair<String> = prefix_match_dict_pair!(
            "(" => ")"
            "[" => "]"
            "{" => "}"
            "<" => ">"
        );
        show!(&d);
        // æµ‹è¯•å‰ç¼€åŒ¹é…
        test_match_prefix! {
            d;
            // èŒƒå›´å†…æƒ…å†µ
            r"(A, B, C)" => Some(")")
            r"[A, B, C]" => Some("]")
            r"{A, B, C}" => Some("}")
            r"<A, B, C>" => Some(">")
            // æ— æ•ˆæƒ…å†µ
            "word" => None
        }

        // æµ‹è¯•ã€Œé¢„ç®—å€¼ã€åŒ¹é…
        let d: PrefixMatchDictPair<String> = prefix_match_dict_pair!(
            // é¢„ç®—å€¼ //
            "$" => "$"
            r"\$" => r"\$"
            "é¢„" => "ç®—"
        );
        show!(&d);
        // æµ‹è¯•åç¼€åŒ¹é…
        test_match_prefix! {
            d;
            // èŒƒå›´å†…æƒ…å†µ | â—åç¼€â‡’å‰ç¼€ //
            // ASCII
            "$0.4;0.4;0.4$ <A-->B>." => Some("$")
            // LaTeX
            r"\$0.4;0.4;0.4\$ \left<A \rightarrow  B\right>." => Some(r"\$")
            // æ¼¢æ–‡
            "é¢„0.4ã€0.4ã€0.4ç®—ã€ŒAæ˜¯Bã€ã€‚" => Some("ç®—")
            // æ— æ•ˆæƒ…å†µ //
            "word" => None
        }
    }
}
